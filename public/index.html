<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾·å·æ’²å…‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        #app {
            width: 100%;
            max-width: 800px;
        }

        .screen {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .screen.active {
            display: block;
        }

        h1 {
            color: #1e3c72;
            text-align: center;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        button {
            width: 100%;
            padding: 15px;
            background: #2a5298;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }

        button:hover {
            background: #1e3c72;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #game-screen {
            background: #0d5d0d;
            color: white;
        }

        .poker-table {
            background: #1a7a1a;
            border-radius: 200px;
            padding: 40px 20px;
            margin: 20px 0;
            border: 8px solid #8b4513;
            position: relative;
        }

        .community-cards {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
            min-height: 100px;
        }

        .card {
            width: 60px;
            height: 85px;
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .card.red {
            color: #e74c3c;
        }

        .card.black {
            color: #2c3e50;
        }

        .card.back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .players {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .player {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid transparent;
        }

        .player.active {
            border-color: #ffd700;
            background: rgba(255,215,0,0.2);
        }

        .player.current-user {
            border-color: #4CAF50;
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .player-chips {
            color: #ffd700;
        }

        .player-cards {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .actions button {
            flex: 1;
            min-width: 100px;
        }

        .pot-info {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            margin: 20px 0;
        }

        .bet-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .bet-input input {
            flex: 1;
        }

        .status-message {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            margin: 10px 0;
        }

        @media (max-width: 600px) {
            .card {
                width: 45px;
                height: 65px;
                font-size: 18px;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ç™»å…¥ç•«é¢ -->
        <div id="login-screen" class="screen active">
            <h1>ğŸƒ å¾·å·æ’²å…‹</h1>
            <div class="input-group">
                <label for="player-name">ç©å®¶åç¨±</label>
                <input type="text" id="player-name" placeholder="è¼¸å…¥ä½ çš„åç¨±">
            </div>
            <div class="input-group">
                <label for="room-id">æˆ¿é–“ IDï¼ˆé¸å¡«ï¼Œç•™ç©ºå‰‡å»ºç«‹æ–°æˆ¿é–“ï¼‰</label>
                <input type="text" id="room-id" placeholder="è¼¸å…¥æˆ¿é–“ ID æˆ–ç•™ç©º">
            </div>
            <button id="join-btn">åŠ å…¥éŠæˆ²</button>
        </div>

        <!-- ç­‰å¾…ç•«é¢ -->
        <div id="lobby-screen" class="screen">
            <h1>ç­‰å¾…å…¶ä»–ç©å®¶</h1>
            <div class="status-message">
                <p>æˆ¿é–“ ID: <strong id="current-room-id"></strong></p>
                <p>å·²åŠ å…¥ç©å®¶æ•¸: <strong id="player-count">1</strong></p>
                <p>åˆ†äº«æˆ¿é–“ ID çµ¦ä½ çš„æœ‹å‹ï¼</p>
            </div>
            <div id="lobby-players"></div>
            <button id="start-game-btn">é–‹å§‹éŠæˆ²ï¼ˆè‡³å°‘éœ€è¦2äººï¼‰</button>
        </div>

        <!-- éŠæˆ²ç•«é¢ -->
        <div id="game-screen" class="screen">
            <h1>å¾·å·æ’²å…‹</h1>
            <div class="pot-info">
                åº•æ± : $<span id="pot">0</span>
            </div>
            <div class="poker-table">
                <div class="community-cards" id="community-cards">
                    <!-- å…¬å…±ç‰Œ -->
                </div>
            </div>
            <div class="status-message" id="game-status">
                ç­‰å¾…éŠæˆ²é–‹å§‹...
            </div>
            <div class="players" id="players">
                <!-- ç©å®¶è³‡è¨Š -->
            </div>
            <div class="actions" id="actions">
                <button id="fold-btn">æ£„ç‰Œ (Fold)</button>
                <button id="check-btn">éç‰Œ (Check)</button>
                <button id="call-btn">è·Ÿæ³¨ (Call)</button>
                <button id="raise-btn">åŠ æ³¨ (Raise)</button>
            </div>
            <div class="bet-input">
                <input type="number" id="raise-amount" placeholder="åŠ æ³¨é‡‘é¡" min="0">
                <button id="confirm-raise-btn">ç¢ºèªåŠ æ³¨</button>
            </div>
        </div>
    </div>

    <script>
        // è‡ªå‹•åµæ¸¬æ˜¯å¦ä½¿ç”¨ HTTPSï¼Œä¸¦ä½¿ç”¨å°æ‡‰çš„ WebSocket å”è­°
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const WS_URL = `${protocol}//${window.location.host}`;
        
        let ws = null;
        let playerId = null;
        let roomId = null;
        let gameState = null;

        // ç•«é¢åˆ‡æ›
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // é€£æ¥ WebSocket
        function connectWebSocket() {
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log('WebSocket connected');
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleMessage(message);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                alert('é€£ç·šéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
            };
        }

        // è™•ç†è¨Šæ¯
        function handleMessage(message) {
            switch(message.type) {
                case 'joined':
                    playerId = message.playerId;
                    roomId = message.roomId;
                    document.getElementById('current-room-id').textContent = roomId;
                    showScreen('lobby-screen');
                    break;
                case 'playerJoined':
                    updateLobby(message.players);
                    break;
                case 'gameStarted':
                    gameState = message.gameState;
                    showScreen('game-screen');
                    updateGame(gameState);
                    break;
                case 'gameUpdate':
                    gameState = message.gameState;
                    updateGame(gameState);
                    break;
                case 'error':
                    alert(message.message);
                    break;
            }
        }

        // æ›´æ–°å¤§å»³
        function updateLobby(players) {
            document.getElementById('player-count').textContent = players.length;
            const lobbyPlayers = document.getElementById('lobby-players');
            lobbyPlayers.innerHTML = players.map(p => 
                `<div class="player"><div class="player-name">${p.name}</div></div>`
            ).join('');
            
            const startBtn = document.getElementById('start-game-btn');
            startBtn.disabled = players.length < 2;
        }

        // æ›´æ–°éŠæˆ²ç•«é¢
        function updateGame(state) {
            // æ›´æ–°åº•æ± 
            document.getElementById('pot').textContent = state.pot;

            // æ›´æ–°å…¬å…±ç‰Œ
            const communityCards = document.getElementById('community-cards');
            communityCards.innerHTML = state.communityCards.map(card => 
                renderCard(card)
            ).join('');

            // æ›´æ–°ç©å®¶
            const playersDiv = document.getElementById('players');
            playersDiv.innerHTML = state.players.map(player => {
                const isCurrentUser = player.id === playerId;
                const isActive = player.id === state.currentPlayer;
                
                // æª¢æŸ¥æ˜¯å¦åœ¨ showdown ä¸­
                let handInfo = '';
                if (state.showdownPlayers) {
                    const showdownInfo = state.showdownPlayers.find(sp => sp.id === player.id);
                    if (showdownInfo) {
                        handInfo = `<div style="color: #ffd700; font-size: 12px;">${getHandTypeName(showdownInfo.handRank.type)}</div>`;
                    }
                }
                
                // é¡¯ç¤ºç²å‹è³‡è¨Š
                let winInfo = '';
                if (state.winners) {
                    const winnerInfo = state.winners.find(w => w.id === player.id);
                    if (winnerInfo) {
                        winInfo = `<div style="color: #4CAF50; font-weight: bold;">ğŸ† è´å¾— $${winnerInfo.winAmount}</div>`;
                    }
                }
                
                return `
                    <div class="player ${isActive ? 'active' : ''} ${isCurrentUser ? 'current-user' : ''}">
                        <div class="player-name">${player.name} ${isActive ? 'â­' : ''}</div>
                        <div class="player-chips">ç±Œç¢¼: $${player.chips}</div>
                        <div class="player-chips">ç•¶å‰æ³¨: $${player.currentBet}</div>
                        ${player.folded ? '<div style="color: #ff6b6b;">å·²æ£„ç‰Œ</div>' : ''}
                        ${handInfo}
                        ${winInfo}
                        <div class="player-cards">
                            ${player.cards && player.cards.length > 0 && player.cards[0].rank ? 
                                player.cards.map(card => renderCard(card)).join('') :
                                (player.cards && player.cards.length > 0 ? '<div class="card back">ğŸ‚ </div><div class="card back">ğŸ‚ </div>' : '')
                            }
                        </div>
                    </div>
                `;
            }).join('');

            // æ›´æ–°ç‹€æ…‹è¨Šæ¯
            const statusDiv = document.getElementById('game-status');
            if (state.winners) {
                if (state.winners.length === 1) {
                    statusDiv.textContent = `ğŸ‰ ${state.winners[0].name} ç²å‹ï¼è´å¾— $${state.winners[0].winAmount}`;
                } else {
                    const winnerNames = state.winners.map(w => w.name).join(', ');
                    statusDiv.textContent = `ğŸ‰ å¹³æ‰‹ï¼${winnerNames} å¹³åˆ†åº•æ± `;
                }
            } else {
                const currentPlayerName = state.players.find(p => p.id === state.currentPlayer)?.name;
                const callAmount = state.maxBet - (state.players.find(p => p.id === playerId)?.currentBet || 0);
                statusDiv.textContent = `è¼ªåˆ° ${currentPlayerName} è¡Œå‹• | ç•¶å‰éšæ®µ: ${getStageText(state.stage)} | è·Ÿæ³¨: $${callAmount}`;
            }

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            updateButtons(state);
        }
        
        // å–å¾—æ‰‹ç‰Œé¡å‹åç¨±ï¼ˆå‰ç«¯ç‰ˆæœ¬ï¼‰
        function getHandTypeName(type) {
            const names = ['é«˜ç‰Œ', 'ä¸€å°', 'å…©å°', 'ä¸‰æ¢', 'é †å­', 'åŒèŠ±', 'è‘«è˜†', 'å››æ¢', 'åŒèŠ±é †', 'çš‡å®¶åŒèŠ±é †'];
            return names[type] || 'æœªçŸ¥';
        }

        // æ¸²æŸ“æ’²å…‹ç‰Œ
        function renderCard(card) {
            const suitSymbols = { hearts: 'â™¥', diamonds: 'â™¦', clubs: 'â™£', spades: 'â™ ' };
            const isRed = card.suit === 'hearts' || card.suit === 'diamonds';
            return `<div class="card ${isRed ? 'red' : 'black'}">
                <div>${card.rank}</div>
                <div>${suitSymbols[card.suit]}</div>
            </div>`;
        }

        // å–å¾—éšæ®µæ–‡å­—
        function getStageText(stage) {
            const stages = {
                preflop: 'ç¿»ç‰Œå‰',
                flop: 'ç¿»ç‰Œ',
                turn: 'è½‰ç‰Œ',
                river: 'æ²³ç‰Œ',
                showdown: 'æ”¤ç‰Œ'
            };
            return stages[stage] || stage;
        }

        // æ›´æ–°æŒ‰éˆ•
        function updateButtons(state) {
            const isMyTurn = state.currentPlayer === playerId;
            const currentPlayer = state.players.find(p => p.id === playerId);
            
            if (!currentPlayer) return;
            
            const maxBet = state.maxBet || Math.max(...state.players.map(p => p.currentBet));
            const canCheck = currentPlayer.currentBet === maxBet;
            const callAmount = maxBet - currentPlayer.currentBet;

            document.getElementById('fold-btn').disabled = !isMyTurn;
            document.getElementById('check-btn').disabled = !isMyTurn || !canCheck;
            document.getElementById('call-btn').disabled = !isMyTurn || canCheck;
            document.getElementById('raise-btn').disabled = !isMyTurn;
            document.getElementById('confirm-raise-btn').disabled = !isMyTurn;

            // æ›´æ–°æŒ‰éˆ•æ–‡å­—é¡¯ç¤ºè·Ÿæ³¨é‡‘é¡
            if (canCheck) {
                document.getElementById('call-btn').textContent = 'è·Ÿæ³¨ (Call)';
            } else {
                document.getElementById('call-btn').textContent = `è·Ÿæ³¨ $${callAmount}`;
            }
            
            // è¨­å®šæœ€å°åŠ æ³¨é‡‘é¡æç¤º
            const raiseInput = document.getElementById('raise-amount');
            if (state.lastRaiseAmount) {
                raiseInput.placeholder = `åŠ æ³¨é‡‘é¡ (æœ€å° ${state.lastRaiseAmount})`;
                raiseInput.min = state.lastRaiseAmount;
            }
        }

        // ç™¼é€è¨Šæ¯
        function sendMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
            }
        }

        // äº‹ä»¶ç›£è½
        document.getElementById('join-btn').addEventListener('click', () => {
            const name = document.getElementById('player-name').value.trim();
            const room = document.getElementById('room-id').value.trim();
            
            if (!name) {
                alert('è«‹è¼¸å…¥ç©å®¶åç¨±');
                return;
            }

            connectWebSocket();
            setTimeout(() => {
                sendMessage({
                    type: 'join',
                    playerName: name,
                    roomId: room || undefined
                });
            }, 500);
        });

        document.getElementById('start-game-btn').addEventListener('click', () => {
            sendMessage({ type: 'startGame', roomId });
        });

        document.getElementById('fold-btn').addEventListener('click', () => {
            sendMessage({ type: 'action', action: 'fold', roomId, playerId });
        });

        document.getElementById('check-btn').addEventListener('click', () => {
            sendMessage({ type: 'action', action: 'check', roomId, playerId });
        });

        document.getElementById('call-btn').addEventListener('click', () => {
            sendMessage({ type: 'action', action: 'call', roomId, playerId });
        });

        document.getElementById('raise-btn').addEventListener('click', () => {
            document.getElementById('raise-amount').focus();
        });

        document.getElementById('confirm-raise-btn').addEventListener('click', () => {
            const amount = parseInt(document.getElementById('raise-amount').value);
            if (amount > 0) {
                sendMessage({ type: 'action', action: 'raise', amount, roomId, playerId });
                document.getElementById('raise-amount').value = '';
            }
        });
    </script>
</body>
</html>